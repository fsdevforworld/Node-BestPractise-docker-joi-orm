{"version":3,"file":"www.js","names":["port","normalizePort","process","env","PORT","app","set","onError","error","syscall","code","logger","exit","server","http","createServer","listen","onListening","addr","address","bind","info","on","Date","toISOString","gracefulShutdown","stoppable","log","reason","p"],"sources":["../../../src/bin/www.js"],"sourcesContent":["/* eslint-disable no-unused-vars */\r\n/* eslint-disable no-process-exit */\r\nimport http from 'http'\r\nimport stoppable from 'stoppable'\r\nimport app from '../app'\r\nimport { logger } from '../support/logger'\r\n\r\nimport normalizePort from '../utils/normalize-port'\r\n\r\nimport gracefulShutdown from '../utils/graceful-shutdown'\r\n\r\n/**\r\n * Get port from environment and store in Express.\r\n */\r\n\r\nconst port = normalizePort(process.env.PORT || '3000')\r\n\r\napp.set('port', port)\r\n\r\n/**\r\n * Event listener for HTTP server \"error\" event.\r\n */\r\nconst onError = (error) => {\r\n  if (error.syscall !== 'listen') {\r\n    throw error\r\n  }\r\n\r\n  // handle specific listen errors with friendly messages\r\n  switch (error.code) {\r\n    case 'EACCES':\r\n      logger.error(`Port ${process.env.PORT} requires elevated privileges`)\r\n      process.exit(1)\r\n      break\r\n    case 'EADDRINUSE':\r\n      logger.error(`Port ${process.env.PORT} is already in use`)\r\n      process.exit(1)\r\n      break\r\n    default:\r\n      throw error\r\n  }\r\n}\r\n\r\n/**\r\n * Create HTTP server.\r\n */\r\n\r\nconst server = http.createServer(app)\r\n\r\n/**\r\n * Listen on provided port, on all network interfaces.\r\n */\r\n\r\nserver.listen(port)\r\n\r\n/**\r\n * Event listener for HTTP server \"listening\" event.\r\n */\r\n\r\nfunction onListening() {\r\n  const addr = server.address()\r\n  const bind = typeof addr === 'string' ? `pipe ${addr}` : `port ${addr.port}`\r\n  logger.info(`Listening on ${bind}`)\r\n}\r\n\r\nserver.on('error', onError)\r\nserver.on('listening', onListening)\r\n\r\n// quit on ctrl+c when running docker in terminal\r\nprocess.on('SIGINT', async () => {\r\n  logger.info(\r\n    'Got SIGINT (aka ctrl+c in docker). Graceful shutdown',\r\n    new Date().toISOString()\r\n  )\r\n  await gracefulShutdown(stoppable(server))\r\n})\r\n\r\n// quit properly on docker stop\r\nprocess.on('SIGTERM', async () => {\r\n  logger.log(\r\n    'Got SIGTERM (docker container stop).Graceful shutdown',\r\n    new Date().toISOString()\r\n  )\r\n  await gracefulShutdown(stoppable(server))\r\n})\r\n\r\nprocess.on('unhandledRejection', (reason, p) => {\r\n  // I just caught an unhandled promise rejection,\r\n  // since we already have fallback handler for unhandled errors (see below),\r\n  // let throw and let him handle that\r\n  throw reason\r\n})\r\n\r\nprocess.on('uncaughtException', (error) => {\r\n  // I just received an error that was never handled, time to handle it and then decide whether a restart is needed\r\n  logger.error('There was an uncaught error', error)\r\n  process.exit(1) // mandatory (as per the Node.js docs)\r\n})\r\n"],"mappings":";;AAEA;;AACA;;AACA;;AACA;;AAEA;;AAEA;;;;AATA;;AACA;;AAUA;AACA;AACA;AAEA,MAAMA,IAAI,GAAG,IAAAC,sBAAA,EAAcC,OAAO,CAACC,GAAR,CAAYC,IAAZ,IAAoB,MAAlC,CAAb;;AAEAC,YAAA,CAAIC,GAAJ,CAAQ,MAAR,EAAgBN,IAAhB;AAEA;AACA;AACA;;;AACA,MAAMO,OAAO,GAAIC,KAAD,IAAW;EACzB,IAAIA,KAAK,CAACC,OAAN,KAAkB,QAAtB,EAAgC;IAC9B,MAAMD,KAAN;EACD,CAHwB,CAKzB;;;EACA,QAAQA,KAAK,CAACE,IAAd;IACE,KAAK,QAAL;MACEC,cAAA,CAAOH,KAAP,CAAc,QAAON,OAAO,CAACC,GAAR,CAAYC,IAAK,+BAAtC;;MACAF,OAAO,CAACU,IAAR,CAAa,CAAb;MACA;;IACF,KAAK,YAAL;MACED,cAAA,CAAOH,KAAP,CAAc,QAAON,OAAO,CAACC,GAAR,CAAYC,IAAK,oBAAtC;;MACAF,OAAO,CAACU,IAAR,CAAa,CAAb;MACA;;IACF;MACE,MAAMJ,KAAN;EAVJ;AAYD,CAlBD;AAoBA;AACA;AACA;;;AAEA,MAAMK,MAAM,GAAGC,aAAA,CAAKC,YAAL,CAAkBV,YAAlB,CAAf;AAEA;AACA;AACA;;;AAEAQ,MAAM,CAACG,MAAP,CAAchB,IAAd;AAEA;AACA;AACA;;AAEA,SAASiB,WAAT,GAAuB;EACrB,MAAMC,IAAI,GAAGL,MAAM,CAACM,OAAP,EAAb;EACA,MAAMC,IAAI,GAAG,OAAOF,IAAP,KAAgB,QAAhB,GAA4B,QAAOA,IAAK,EAAxC,GAA6C,QAAOA,IAAI,CAAClB,IAAK,EAA3E;;EACAW,cAAA,CAAOU,IAAP,CAAa,gBAAeD,IAAK,EAAjC;AACD;;AAEDP,MAAM,CAACS,EAAP,CAAU,OAAV,EAAmBf,OAAnB;AACAM,MAAM,CAACS,EAAP,CAAU,WAAV,EAAuBL,WAAvB,E,CAEA;;AACAf,OAAO,CAACoB,EAAR,CAAW,QAAX,EAAqB,YAAY;EAC/BX,cAAA,CAAOU,IAAP,CACE,sDADF,EAEE,IAAIE,IAAJ,GAAWC,WAAX,EAFF;;EAIA,MAAM,IAAAC,yBAAA,EAAiB,IAAAC,kBAAA,EAAUb,MAAV,CAAjB,CAAN;AACD,CAND,E,CAQA;;AACAX,OAAO,CAACoB,EAAR,CAAW,SAAX,EAAsB,YAAY;EAChCX,cAAA,CAAOgB,GAAP,CACE,uDADF,EAEE,IAAIJ,IAAJ,GAAWC,WAAX,EAFF;;EAIA,MAAM,IAAAC,yBAAA,EAAiB,IAAAC,kBAAA,EAAUb,MAAV,CAAjB,CAAN;AACD,CAND;AAQAX,OAAO,CAACoB,EAAR,CAAW,oBAAX,EAAiC,CAACM,MAAD,EAASC,CAAT,KAAe;EAC9C;EACA;EACA;EACA,MAAMD,MAAN;AACD,CALD;AAOA1B,OAAO,CAACoB,EAAR,CAAW,mBAAX,EAAiCd,KAAD,IAAW;EACzC;EACAG,cAAA,CAAOH,KAAP,CAAa,6BAAb,EAA4CA,KAA5C;;EACAN,OAAO,CAACU,IAAR,CAAa,CAAb,EAHyC,CAGzB;AACjB,CAJD"}